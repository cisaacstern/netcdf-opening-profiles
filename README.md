# netcdf-opening-profiles

## Generating profiles

An opening profile for each of the datasets below was saved to file with iPython's [`%%prun -D` magic](http://ipython.org/ipython-doc/2/api/generated/IPython.core.magics.execution.html#IPython.core.magics.execution.ExecutionMagics.prun). 

> Here, "opening" means calling `xr.open_dataset` on an fsspec `OpenFile`. This call is run from a Pangeo notebook running in GCP's region `us-central1-b` and the target file is located on Pangeo Forge's GCS cache, which is also located in Google's `us-central` region. The notebook used to run these profiles is located in the [project repo](https://github.com/cisaacstern/netcdf-opening-profiles/blob/main/profiles.ipynb).

To view a Snakeviz rendering of each of these profiles in your browser, click on the dataset name in the table below.

## Snakeviz links

| Dataset Name                          | On-disk size | In-memory size |`xr.open_dataset` time |
| ------------------------------------- | ------------ | -------------- | --------------------- |
| [enatl60-region01-interior-aso-2009-09](https://cisaacstern.github.io/netcdf-opening-profiles/enatl60-region01-interior-aso-2009-09.html) | 31.76 GB     | 31.76 GB | 6 seconds          |
| [cesm-pop-lowres-1deg-sss](https://cisaacstern.github.io/netcdf-opening-profiles/cesm-pop-lowres-1deg-sss.html) | 16.61 GB | 29.80 GB | 580 seconds |

> To generate the above-linked pages for each profile, the following steps were followed:
> 1. Serve the `.prof` file generated by `%%prun -D` to localhost using the [Snakeviz CLI](https://jiffyclub.github.io/snakeviz/)
> 2. Save the resulting webpage as HTML using the browser's **Save Page As...** (or equivalent) menu option
> 3. Replace local resource links using [`svstatic.py`](https://github.com/cisaacstern/netcdf-opening-profiles/blob/main/svstatic.py), e.g.: `python svstatic.py myfile.html > myfile_static.html`

## Hypotheses

The eNATL60 dataset opens ~100x faster than the CESM-POP dataset does. Factors which may contribute to this difference include:

- **Compression ratio**: Despite being roughly the same size in-memory, eNATL60 is not compressed on disk, whereas CESM-POP is.
- **Number of data variables**: eNATL60 has 13, whereas CESM-POP has 51.
- **Internal metadata organization**: Opening can be slowed if metadata is scattered throughout a file, rather than being concentrated in one location. Further investigation is required to determine the byte-location(s) of metadata for each of these files.
